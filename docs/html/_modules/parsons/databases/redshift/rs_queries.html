

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>parsons.databases.redshift.rs_queries &mdash; Parsons 0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../index.html" class="icon icon-home"> Parsons
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Integrations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../action_kit.html">ActionKit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../civis.html">Civis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../facebook_ads.html">FacebookAds</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../google_sheets.html">GoogleSheets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mobile_commons.html">Mobile Commons</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mobilize_america.html">Mobilize America</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ngpvan.html">VAN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../p2a.html">Phone2Action</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../redshift.html">Redshift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../s3.html">S3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sftp.html">SFTP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ts.html">TargetSmart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../turbovote.html">TurboVote</a></li>
</ul>
<p class="caption"><span class="caption-text">Framework</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../table.html">Parsons Table</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notifications.html">Notifications</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Parsons</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../redshift.html">parsons.databases.redshift</a> &raquo;</li>
        
      <li>parsons.databases.redshift.rs_queries</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for parsons.databases.redshift.rs_queries</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RedshiftQueries</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">rename_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">new_table_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rename an existing table.</span>

<span class="sd">        .. note::</span>
<span class="sd">            You cannot move schemas when renaming a table. Instead, utilize</span>
<span class="sd">            the :meth:``parsons.Redshift.table_duplicate.`` method.</span>

<span class="sd">        Args:</span>
<span class="sd">            table_name: str</span>
<span class="sd">                Name of existing schema and table (e.g. ``myschema.oldtable``)</span>
<span class="sd">            new_table_name: str</span>
<span class="sd">                New name for table. Note: Omit schema in table name.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;alter table </span><span class="si">{table_name}</span><span class="s2"> rename to </span><span class="si">{new_table_name}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{table_name}</span><span class="s2"> renamed to </span><span class="si">{new_table_name}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">move_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_table</span><span class="p">,</span> <span class="n">new_table</span><span class="p">,</span> <span class="n">drop_source_table</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move an existing table in the database.</span>

<span class="sd">        It will inherit encoding, sortkey and distkey. **Once run, the source table</span>
<span class="sd">        rows will be empty.** This is more efficiant than running</span>
<span class="sd">        ``&quot;create newtable as select * from oldtable&quot;``.</span>

<span class="sd">        For more imformation see: `ALTER TABLE APPEND &lt;https://docs.aws.amazon.com/redshift/latest/dg/r_ALTER_TABLE_APPEND.html&gt;`_</span>

<span class="sd">        Args:</span>
<span class="sd">            source_table: str</span>
<span class="sd">                Name of existing schema and table (e.g. ``myschema.oldtable``)</span>
<span class="sd">            new_table: str</span>
<span class="sd">                New name of schema and table (e.g. ``myschema.newtable``)</span>
<span class="sd">            drop_original: boolean</span>
<span class="sd">                Drop the source table.</span>
<span class="sd">        Returns:</span>
<span class="sd">                None</span>
<span class="sd">        &quot;&quot;&quot;</span> <span class="c1"># noqa: E501,E261</span>

        <span class="c1"># To Do: Add the grants</span>
        <span class="c1"># To Do: Argument for if the table exists?</span>
        <span class="c1"># To Do: Add the ignore extra kwarg.</span>

        <span class="n">create_sql</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;create table </span><span class="si">{new_table}</span><span class="s2"> (like </span><span class="si">{source_table}</span><span class="s2">);&quot;</span>
        <span class="n">alter_sql</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;alter table </span><span class="si">{new_table}</span><span class="s2"> append from </span><span class="si">{source_table}</span><span class="s2">&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Creating empty </span><span class="si">{new_table}</span><span class="s1"> from </span><span class="si">{source_table}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">create_sql</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>

            <span class="c1">#  An ALTER TABLE statement can&#39;t be run within a block, meaning</span>
            <span class="c1">#  that it needs to be committed on running. To enable this,</span>
            <span class="c1">#  the connection must be set to autocommit.</span>

            <span class="n">conn</span><span class="o">.</span><span class="n">set_session</span><span class="p">(</span><span class="n">autocommit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Moving data from </span><span class="si">{source_table}</span><span class="s1"> to </span><span class="si">{new_table}</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query_with_connection</span><span class="p">(</span><span class="n">alter_sql</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">drop_source_table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;drop table </span><span class="si">{source_table}</span><span class="s2">;&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{source_table}</span><span class="s1"> dropped.&#39;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{source_table}</span><span class="s1"> data moved from </span><span class="si">{new_table}</span><span class="s1">  .&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_table_precheck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">if_exists</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper to determine what to do when you need a table that may already exist.</span>

<span class="sd">        `Args:`</span>
<span class="sd">            connection: obj</span>
<span class="sd">                A connection object obtained from ``redshift.connection()``</span>
<span class="sd">            table_name: str</span>
<span class="sd">                The table to check</span>
<span class="sd">            if_exists: str</span>
<span class="sd">                If the table already exists, either ``fail``, ``append``, ``drop``,</span>
<span class="sd">                or ``truncate`` the table.</span>
<span class="sd">        `Returns:`</span>
<span class="sd">            bool</span>
<span class="sd">                True if the table needs to be created, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">if_exists</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fail&#39;</span><span class="p">,</span> <span class="s1">&#39;truncate&#39;</span><span class="p">,</span> <span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="s1">&#39;drop&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for `if_exists` argument&quot;</span><span class="p">)</span>

        <span class="n">exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_exists_with_connection</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">exists</span> <span class="ow">and</span> <span class="n">if_exists</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fail&#39;</span><span class="p">,</span> <span class="s1">&#39;truncate&#39;</span><span class="p">,</span> <span class="s1">&#39;append&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">if_exists</span> <span class="o">==</span> <span class="s1">&#39;fail&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Table already exists.&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">if_exists</span> <span class="o">==</span> <span class="s1">&#39;truncate&#39;</span><span class="p">:</span>
                <span class="n">truncate_sql</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;truncate table </span><span class="si">{table_name}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query_with_connection</span><span class="p">(</span><span class="n">truncate_sql</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exists</span> <span class="ow">and</span> <span class="n">if_exists</span> <span class="o">==</span> <span class="s1">&#39;drop&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Table </span><span class="si">{table_name}</span><span class="s2"> exist, will drop...&quot;</span><span class="p">)</span>
                <span class="n">drop_sql</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;drop table </span><span class="si">{table_name}</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query_with_connection</span><span class="p">(</span><span class="n">drop_sql</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">populate_table_from_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">destination_table</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;fail&#39;</span><span class="p">,</span> <span class="n">distkey</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">sortkey</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Populate a Redshift table with the results of a SQL query, creating the table if it</span>
<span class="sd">        doesn&#39;t yet exist.</span>

<span class="sd">        `Args:`</span>
<span class="sd">            query: str</span>
<span class="sd">                The SQL query</span>
<span class="sd">            destination_table: str</span>
<span class="sd">                Name of destination schema and table (e.g. ``myschema.newtable``)</span>
<span class="sd">            if_exists: str</span>
<span class="sd">                If the table already exists, either ``fail``, ``append``, ``drop``,</span>
<span class="sd">                or ``truncate`` the table.</span>
<span class="sd">            distkey: str</span>
<span class="sd">                The column to use as the distkey for the table.</span>
<span class="sd">            sortkey: str</span>
<span class="sd">                The column to use as the sortkey for the table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">should_create</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_table_precheck</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">destination_table</span><span class="p">,</span> <span class="n">if_exists</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">should_create</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Creating table </span><span class="si">{destination_table}</span><span class="s2"> from query...&quot;</span><span class="p">)</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;create table </span><span class="si">{destination_table}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">distkey</span><span class="p">:</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">&quot; distkey(</span><span class="si">{distkey}</span><span class="s2">)&quot;</span>
                <span class="k">if</span> <span class="n">sortkey</span><span class="p">:</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">&quot; sortkey(</span><span class="si">{sortkey}</span><span class="s2">)&quot;</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">&quot; as </span><span class="si">{query}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Inserting data into </span><span class="si">{destination_table}</span><span class="s2"> from query...&quot;</span><span class="p">)</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;insert into </span><span class="si">{destination_table}</span><span class="s2"> (</span><span class="si">{query}</span><span class="s2">)&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">query_with_connection</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{destination_table}</span><span class="s1"> created from query&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">duplicate_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_table</span><span class="p">,</span> <span class="n">destination_table</span><span class="p">,</span> <span class="n">where_clause</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                        <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;fail&#39;</span><span class="p">,</span> <span class="n">drop_source_table</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a copy of an existing table (or subset of rows) in a new</span>
<span class="sd">        table. It will inherit encoding, sortkey and distkey.</span>

<span class="sd">        `Args:`</span>
<span class="sd">            source_table: str</span>
<span class="sd">                Name of existing schema and table (e.g. ``myschema.oldtable``)</span>
<span class="sd">            destination_table: str</span>
<span class="sd">                Name of destination schema and table (e.g. ``myschema.newtable``)</span>
<span class="sd">            where_clause: str</span>
<span class="sd">                An optional where clause (e.g. ``where org = 1``).</span>
<span class="sd">            if_exists: str</span>
<span class="sd">                If the table already exists, either ``fail``, ``append``, ``drop``,</span>
<span class="sd">                or ``truncate`` the table.</span>
<span class="sd">            drop_source_table: boolean</span>
<span class="sd">                Drop the source table</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">should_create</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_table_precheck</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">destination_table</span><span class="p">,</span> <span class="n">if_exists</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">should_create</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Creating </span><span class="si">{destination_table}</span><span class="s1"> from </span><span class="si">{source_table}</span><span class="s1">...&#39;</span><span class="p">)</span>
                <span class="n">create_sql</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;create table </span><span class="si">{destination_table}</span><span class="s2"> (like </span><span class="si">{source_table}</span><span class="s2">)&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query_with_connection</span><span class="p">(</span><span class="n">create_sql</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Transferring data to </span><span class="si">{destination_table}</span><span class="s2"> from </span><span class="si">{source_table}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">select_sql</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;select * from </span><span class="si">{source_table}</span><span class="s2"> </span><span class="si">{where_clause}</span><span class="s2">&quot;</span>
            <span class="n">insert_sql</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;insert into </span><span class="si">{destination_table}</span><span class="s2"> (</span><span class="si">{select_sql}</span><span class="s2">)&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query_with_connection</span><span class="p">(</span><span class="n">insert_sql</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">drop_source_table</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Dropping table </span><span class="si">{source_table}</span><span class="s1">...&#39;</span><span class="p">)</span>
                <span class="n">drop_sql</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;drop table </span><span class="si">{source_table}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query_with_connection</span><span class="p">(</span><span class="n">drop_sql</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{destination_table}</span><span class="s1"> created from </span><span class="si">{source_table}</span><span class="s1">.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">union_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_table_name</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">union_all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Union a series of table into a new table.</span>

<span class="sd">        Args:</span>
<span class="sd">            new_table_name: str</span>
<span class="sd">                The new table and schema (e.g. ``myschema.newtable``)</span>
<span class="sd">            tables: list</span>
<span class="sd">                A list of tables to union</span>
<span class="sd">            union_all: boolean</span>
<span class="sd">                If ``False`` will dedupe rows</span>
<span class="sd">            view: boolean</span>
<span class="sd">                Create a view rather than a static table</span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">union_type</span> <span class="o">=</span> <span class="s2">&quot; UNION ALL&quot;</span> <span class="k">if</span> <span class="n">union_all</span> <span class="k">else</span> <span class="s2">&quot; UNION&quot;</span>
        <span class="n">table_type</span> <span class="o">=</span> <span class="s2">&quot;VIEW&quot;</span> <span class="k">if</span> <span class="n">view</span> <span class="k">else</span> <span class="s2">&quot;TABLE&quot;</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;CREATE </span><span class="si">{table_type}</span><span class="s2"> </span><span class="si">{new_table_name}</span><span class="s2"> AS&quot;</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tables</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="n">union_type</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">&quot; SELECT * FROM </span><span class="si">{t}</span><span class="s2">&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Created </span><span class="si">{new_table_name}</span><span class="s2"> from {&#39;, &#39;.join(tables)}&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List the tables in a schema including metadata.</span>

<span class="sd">        Args:</span>
<span class="sd">            schema: str</span>
<span class="sd">                Filter by a schema</span>
<span class="sd">            table_name: str</span>
<span class="sd">                Filter by a table name</span>
<span class="sd">        `Returns:`</span>
<span class="sd">            Parsons Table</span>
<span class="sd">                See :ref:`parsons-table` for output options.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Retrieving tables info.&quot;</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;select * from pg_tables&quot;</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">or</span> <span class="n">table_name</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">&quot; where&quot;</span>
        <span class="k">if</span> <span class="n">schema</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">&quot; schemaname = &#39;</span><span class="si">{schema}</span><span class="s2">&#39;&quot;</span>
        <span class="k">if</span> <span class="n">table_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">schema</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; and&quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">&quot; tablename = &#39;</span><span class="si">{table_name}</span><span class="s2">&#39;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_table_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List the tables statistics includes row count and size.</span>

<span class="sd">        .. warning::</span>
<span class="sd">           This method is only accessible by Redshift *superusers*.</span>

<span class="sd">        `Args:`</span>
<span class="sd">            schema: str</span>
<span class="sd">                Filter by a schema</span>
<span class="sd">            table_name: str</span>
<span class="sd">                Filter by a table name</span>
<span class="sd">        `Returns:`</span>
<span class="sd">            Parsons Table</span>
<span class="sd">                See :ref:`parsons-table` for output options.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Retrieving table statistics.&quot;</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;select * from svv_table_info&quot;</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">or</span> <span class="n">table_name</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">&quot; where&quot;</span>
        <span class="k">if</span> <span class="n">schema</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">&quot; schema = &#39;</span><span class="si">{schema}</span><span class="s2">&#39;&quot;</span>
        <span class="k">if</span> <span class="n">table_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">schema</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; and &quot;</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">&quot; </span><span class="se">\&quot;</span><span class="s2">table</span><span class="se">\&quot;</span><span class="s2"> = &#39;</span><span class="si">{table_name}</span><span class="s2">&#39;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the column names (and some other column info) for a table.</span>

<span class="sd">        If you just need the column names, you can treat the return value like a list, eg:</span>

<span class="sd">        .. code-block:: python</span>
<span class="sd">          for col in rs.get_columns(&#39;some_schema&#39;, &#39;some_table&#39;):</span>
<span class="sd">            print(col)</span>

<span class="sd">        `Args:`</span>
<span class="sd">            schema: str</span>
<span class="sd">                The schema name</span>
<span class="sd">            table_name: str</span>
<span class="sd">                The table name</span>
<span class="sd">        `Returns:`</span>
<span class="sd">            A dict mapping column name to a dict with extra info. The keys of the dict are ordered</span>
<span class="sd">            just like the columns in the table. The extra info is a dict with format {</span>
<span class="sd">              &#39;data_type&#39;: str,</span>
<span class="sd">              &#39;max_length&#39;: int or None,</span>
<span class="sd">              &#39;is_nullable&#39;: bool,</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            select ordinal_position,</span>
<span class="s2">                   column_name,</span>
<span class="s2">                   data_type,</span>
<span class="s2">                   case when character_maximum_length is not null</span>
<span class="s2">                        then character_maximum_length</span>
<span class="s2">                        else numeric_precision end as max_length,</span>
<span class="s2">                   is_nullable</span>
<span class="s2">            from information_schema.columns</span>
<span class="s2">            where table_name = &#39;</span><span class="si">{table_name}</span><span class="s2">&#39;</span>
<span class="s2">            and table_schema = &#39;</span><span class="si">{schema}</span><span class="s2">&#39;</span>
<span class="s2">            order by ordinal_position</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;column_name&#39;</span><span class="p">]:</span> <span class="p">{</span>
                <span class="s1">&#39;data_type&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;data_type&#39;</span><span class="p">],</span>
                <span class="s1">&#39;max_length&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;max_length&#39;</span><span class="p">],</span>
                <span class="s1">&#39;is_nullable&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;is_nullable&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;YES&#39;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_views</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List views.</span>

<span class="sd">        Args:</span>
<span class="sd">            schema: str</span>
<span class="sd">                Filter by a schema</span>
<span class="sd">            view: str</span>
<span class="sd">                Filter by a table name</span>
<span class="sd">        `Returns:`</span>
<span class="sd">            Parsons Table</span>
<span class="sd">                See :ref:`parsons-table` for output options.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Retrieving views info.&quot;</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">              select table_schema as schema_name,</span>
<span class="s2">              table_name as view_name,</span>
<span class="s2">              view_definition</span>
<span class="s2">              from information_schema.views</span>
<span class="s2">              where table_schema not in (&#39;information_schema&#39;, &#39;pg_catalog&#39;)</span>
<span class="s2">              &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">schema</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">&quot; and table_schema = &#39;</span><span class="si">{schema}</span><span class="s2">&#39;&quot;</span>
        <span class="k">if</span> <span class="n">view</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="n">f</span><span class="s2">&quot; and table_name = &#39;</span><span class="si">{view}</span><span class="s2">&#39;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_queries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the Current queries running and queueing, along with resource consumption.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            Must be a Redshift superuser to run this method.</span>

<span class="sd">        `Returns:`</span>
<span class="sd">            Parsons Table</span>
<span class="sd">                See :ref:`parsons-table` for output options.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Retrieving running and queued queries.&#39;</span><span class="p">)</span>

        <span class="c1"># Lifted from Redshift Utils https://github.com/awslabs/amazon-redshift-utils/blob/master/src/AdminScripts/running_queues.sql # noqa: E501</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">              select trim(u.usename) as user,</span>
<span class="s2">                s.pid,</span>
<span class="s2">                q.xid,</span>
<span class="s2">                q.query,</span>
<span class="s2">                q.service_class as service_class,</span>
<span class="s2">                q.slot_count as slot,</span>
<span class="s2">                date_trunc(&#39;second&#39;,</span>
<span class="s2">                q.wlm_start_time) as start,</span>
<span class="s2">                decode(trim(q.state),</span>
<span class="s2">                    &#39;Running&#39;,</span>
<span class="s2">                    &#39;Run&#39;,</span>
<span class="s2">                    &#39;QueuedWaiting&#39;,</span>
<span class="s2">                    &#39;Queue&#39;,</span>
<span class="s2">                    &#39;Returning&#39;,</span>
<span class="s2">                    &#39;Return&#39;,trim(q.state)) as state,</span>
<span class="s2">                q.queue_Time/1000000 as queue_sec,</span>
<span class="s2">                q.exec_time/1000000 as exec_sec,</span>
<span class="s2">                m.cpu_time/1000000 cpu_sec,</span>
<span class="s2">                m.blocks_read read_mb,</span>
<span class="s2">                decode(m.blocks_to_disk,-1,null,m.blocks_to_disk) spill_mb,</span>
<span class="s2">                m2.rows as return_rows,</span>
<span class="s2">                m3.rows as NL_rows,</span>
<span class="s2">                substring(replace(nvl(qrytext_cur.text,trim(translate(s.text,chr(10)||chr(13)||chr(9) ,&#39;&#39;))),&#39;</span><span class="se">\\</span><span class="s2">n&#39;,&#39; &#39;),1,90) as sql, -- # noqa: E501</span>
<span class="s2">                trim(decode(event&amp;1,1,&#39;SK &#39;,&#39;&#39;) || decode(event&amp;2,2,&#39;Del &#39;,&#39;&#39;) || decode(event&amp;4,4,&#39;NL &#39;,&#39;&#39;) ||  decode(event&amp;8,8,&#39;Dist &#39;,&#39;&#39;) || decode(event&amp;16,16,&#39;Bcast &#39;,&#39;&#39;) || decode(event&amp;32,32,&#39;Stats &#39;,&#39;&#39;)) as Alert -- # noqa: E501</span>
<span class="s2">            from stv_wlm_query_state q</span>
<span class="s2">            left outer join stl_querytext s on (s.query=q.query and sequence = 0)</span>
<span class="s2">            left outer join stv_query_metrics m on ( q.query = m.query and m.segment=-1 and m.step=-1 )</span>
<span class="s2">            left outer join stv_query_metrics m2 on ( q.query = m2.query and m2.step_type = 38 )</span>
<span class="s2">            left outer join ( select query, sum(rows) as rows from stv_query_metrics m3 where step_type = 15 group by 1) as m3 on ( q.query = m3.query ) -- # noqa: E501</span>
<span class="s2">            left outer join pg_user u on ( s.userid = u.usesysid )</span>
<span class="s2">            LEFT OUTER JOIN (SELECT ut.xid,&#39;CURSOR &#39; || TRIM( substring ( TEXT from strpos(upper(TEXT),&#39;SELECT&#39;) )) as TEXT</span>
<span class="s2">            FROM stl_utilitytext ut</span>
<span class="s2">            WHERE sequence = 0</span>
<span class="s2">               AND upper(TEXT) like &#39;DECLARE%&#39;</span>
<span class="s2">               GROUP BY text, ut.xid) qrytext_cur ON (q.xid = qrytext_cur.xid)</span>
<span class="s2">            left outer join ( select query,sum(decode(trim(split_part(event,&#39;:&#39;,1)),&#39;Very selective query filter&#39;,1,&#39;Scanned a large number of deleted rows&#39;,2,&#39;Nested Loop Join in the query plan&#39;,4,&#39;Distributed a large number of rows across the network&#39;,8,&#39;Broadcasted a large number of rows across the network&#39;,16,&#39;Missing query planner statistics&#39;,32,0)) as event from STL_ALERT_EVENT_LOG -- # noqa: E501</span>
<span class="s2">            where event_time &gt;=  dateadd(hour, -8, current_Date) group by query  ) as alrt on alrt.query = q.query -- # noqa: E501</span>
<span class="s2">            &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_max_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">date_column</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the max date from a table.a</span>

<span class="sd">        `Args:`</span>
<span class="sd">            table_name: str</span>
<span class="sd">                Schema and table name</span>
<span class="sd">            date_column: str</span>
<span class="sd">                The column containing the date</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;SELECT MAX(</span><span class="si">{date_column}</span><span class="s1">) date from </span><span class="si">{table_name}</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, The Movement Cooperative

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    

  

  <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>